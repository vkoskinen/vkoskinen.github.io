"serviceWorker"in navigator&&window.addEventListener("load",(()=>{navigator.serviceWorker.register("../sw.js").then((()=>{console.log("Service Worker Registered")}))}));const here={apiKey:"eXgIn9z6_ajJGIOlSJydOcTe8pa4GzX3Vd_enIhf8q8"},style="normal.day";L.mapbox.MMLaccessToken="api-key=a8a60737-7849-4969-a55e-7b83db77e13a",L.mapbox.accessToken="pk.eyJ1IjoidmVzcSIsImEiOiJjazdycjhwNnEwNmhzM3BwY3dzb2VocjB3In0.5v1gD0iaeanchGkPLGt6Rg";var map=L.map("map",{center:[65.425,27.51],zoom:5,minZoom:5,maxZoom:16,zoomControl:!1}),popup=L.popup({closeButton:!0,autoClose:!0,className:"custom-popup"}),popupOptions={maxWidth:"300",className:"custom-popup"},myRenderer=L.canvas({padding:.5,tolerance:20});maastokartta=new L.tileLayer.mml_wmts({layer:"maastokartta",iconURL:"../images/peruskartta.webp"},attribution="test"),taustakartta=new L.tileLayer.mml_wmts({layer:"taustakartta",iconURL:"../images/taustakartta.webp"}),selkokartta=new L.tileLayer.mml_wmts({layer:"selkokartta",iconURL:"../images/selkokartta.webp"}),hereMap=L.tileLayer("https://2.base.maps.ls.hereapi.com/maptile/2.1/maptile/newest/normal.day/{z}/{x}/{y}/512/png8?apiKey=eXgIn9z6_ajJGIOlSJydOcTe8pa4GzX3Vd_enIhf8q8&ppi=320",{attribution:"&copy HERE",label:"Toner Lite",iconURL:"images/here.webp"}).addTo(map);var mapbox=L.tileLayer("https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}@2x?access_token="+L.mapbox.accessToken,{attribution:'© <a href="https://www.mapbox.com/feedback/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',tileSize:512,zoomOffset:-1,iconURL:"images/mapbox.webp"});roadCover=L.tileLayer.wms("https://julkinen.vayla.fi/inspirepalvelu/avoin/wms?",{layers:"TL137",format:"image/png",transparent:!0,attribution:'<a target="_blank" href="https://vayla.fi/vaylista/aineistot/avoindata/kayttoehdot">Väylävirasto</a>',minZoom:8}),speedLimit=L.tileLayer.wms("https://julkinen.vayla.fi/inspirepalvelu/avoin/wms?",{layers:"TL168",format:"image/png",transparent:!0,attribution:'<a target="_blank" href="https://vayla.fi/vaylista/aineistot/avoindata/kayttoehdot">Väylävirasto</a>',minZoom:8});var workingSiteIcon=L.icon({iconUrl:"images/under-construction.png",iconSize:[27,31],iconAnchor:[13.5,17.5],popupAnchor:[0,-11]}),disturbancesIcon=L.icon({iconUrl:"images/icons8-warning-96.png",iconSize:[27,31],iconAnchor:[13.5,17.5],popupAnchor:[0,-11]}),stationIcon=new L.Icon({iconUrl:"js/leaflet-color-markers-master/img/marker-icon-2x-green.png",shadowUrl:"js/leaflet-color-markers-master/img/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),cafeIcon=new L.Icon({iconUrl:"js/leaflet-color-markers-master/img/marker-icon-2x-red.png",shadowUrl:"js/leaflet-color-markers-master/img/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});function highlight(e){e.setStyle({weight:5,color:"red",dashArray:""}),L.Browser.ie||L.Browser.opera||e.bringToFront()}function dehighlight(e){null!==selected&&selected._leaflet_id===e._leaflet_id||geojson.resetStyle(e)}function select(e){if(null!==selected)var t=selected;map.fitBounds(e.getBounds()),selected=e,t&&dehighlight(t)}workingSitesPoints=L.esri.featureLayer({url:" https://services1.arcgis.com/rhs5fjYxdOG1Et61/ArcGIS/rest/services/TrafficMessages/FeatureServer/3",isModern:!0,pointToLayer:function(e,t){return L.marker(t,{icon:workingSiteIcon})},onEachFeature:function(e,t){var a=new Date(e.properties.startTime),o=new Date(e.properties.endTime);if(null==e.properties.comment)var r="<p><strong>"+e.properties.title+"</strong><br><br>Tarkenne: "+e.properties.locationDescription+"<br><br>Ajankohta: "+a.toLocaleString()+" - "+o.toLocaleString();else r="<p><strong>"+e.properties.title+"</strong><br><br>"+e.properties.comment+"<br><br>Tarkenne: "+e.properties.locationDescription+"<br><br>Ajankohta: "+a.toLocaleString()+" - "+o.toLocaleString();t.bindPopup(r,popupOptions)}}),workingSitesLines=L.esri.featureLayer({url:" https://services1.arcgis.com/rhs5fjYxdOG1Et61/ArcGIS/rest/services/TrafficMessages/FeatureServer/4",isModern:!0,renderer:myRenderer,style:function(e){return{color:"#FF7F00",weight:7}},onEachFeature:function(e,t){var a=new Date(e.properties.startTime),o=new Date(e.properties.endTime);if(null==e.properties.comment)var r="<p><strong>"+e.properties.title+"</strong><br><br>Tarkenne: "+e.properties.locationDescription+"<br><br>Ajankohta: "+a.toLocaleString()+" - "+o.toLocaleString();else r="<p><strong>"+e.properties.title+"</strong><br><br>"+e.properties.comment+"<br><br>Tarkenne: "+e.properties.locationDescription+"<br><br>Ajankohta: "+a.toLocaleString()+" - "+o.toLocaleString();t.bindPopup(r,popupOptions)}}),workingSitesGroup=L.featureGroup([workingSitesPoints,workingSitesLines]);var selected=null;function createClusterIcon(e,t){if(!e.properties.cluster)return L.marker(t);const a=e.properties.point_count,o=a<100?"small":a<1e3?"medium":"large",r=L.divIcon({html:`<div><span>${e.properties.point_count_abbreviated}</span></div>`,className:`marker-cluster marker-cluster-${o}`,iconSize:L.point(40,40)});return L.marker(t,{icon:r})}var geojson=new L.GeoJSON.AJAX("data/mutkat.geojson",{renderer:myRenderer,color:"#ffffff",weight:3,opacity:.35,raised:!1,filter:function(e,t){return"LineString"==e.geometry.type},style:function(e){return{weight:4,opacity:1,color:"blue"}},onEachFeature:function(e,t){var a=void 0!==e.properties.name?e.properties.name:"Ei tietoa";if(null==a)var o="Ei tietoa";if(null==e.properties.description)o="Reitin nimi: "+a;else o="Virhe haussa";t.bindPopup(o,popupOptions),t.on({mouseover:function(e){highlight(e.target)},mouseout:function(e){dehighlight(e.target)},click:function(e){select(e.target)}})}});disturbancesLines=L.esri.featureLayer({url:" https://services1.arcgis.com/rhs5fjYxdOG1Et61/ArcGIS/rest/services/TrafficMessages/FeatureServer/1",isModern:!0,renderer:myRenderer,style:function(e){return{color:"#E41A1C",weight:7}},pointToLayer:function(e,t){return L.marker(t,{icon:disturbancesIcon})},onEachFeature:function(e,t){var a=new Date(e.properties.startTime);new Date(e.properties.endTime);if(null==e.properties.comment)var o="<p><strong>"+e.properties.title+"</strong><br><br>Tarkenne: "+e.properties.locationDescription+"<br>"+e.properties.featureName+"<br><br>Ajankohta: "+a.toLocaleString();else o="<p><strong>"+e.properties.title+"</strong><br><br>Tarkenne: "+e.properties.locationDescription+"<br>"+e.properties.featureName+"<br>"+e.properties.comment+"<br><br>Ajankohta: "+a.toLocaleString();t.bindPopup(o,popupOptions)}}),disturbancesPoints=L.esri.featureLayer({url:" https://services1.arcgis.com/rhs5fjYxdOG1Et61/ArcGIS/rest/services/TrafficMessages/FeatureServer/0",isModern:!0,renderer:myRenderer,pointToLayer:function(e,t){return L.marker(t,{icon:disturbancesIcon})},onEachFeature:function(e,t){var a=new Date(e.properties.startTime);new Date(e.properties.endTime);if(null==e.properties.comment)var o="<p><strong>"+e.properties.title+"</strong><br><br>Tarkenne: "+e.properties.locationDescription+"<br>"+e.properties.featureName+"<br><br>Ajankohta: "+a.toLocaleString();else o="<p><strong>"+e.properties.title+"</strong><br><br>Tarkenne: "+e.properties.locationDescription+"<br>"+e.properties.featureName+"<br>"+e.properties.comment+"<br><br>Ajankohta: "+a.toLocaleString();t.bindPopup(o,popupOptions)}}),disturbancesGroup=L.featureGroup([disturbancesPoints,disturbancesLines]);var stations=new L.GeoJSON.AJAX("data/fuel.min.geojson",{minZoom:8,filter:function(e,t){return null!=e.properties.name},pointToLayer:function(e,t){return L.marker(t,{icon:stationIcon})},onEachFeature:function(e,t){var a=void 0!==e.properties.name?e.properties.name:"Ei tietoa",o=e.properties.website,r=e.properties.url,i=void 0!==e.properties.url?e.properties.url:e.properties.website,n=void 0!==e.properties.opening_hours?e.properties.opening_hours:"Ei tietoa";if(null==a)var s="Ei tietoa";if(null==o&&null==r)s="Asema: "+a+"<br>Aukiolo: "+n;else s='Asema: <a target="_blank" href='+i+">"+a+"</a><br>Aukiolo: "+n;t.bindPopup(s,popupOptions).openPopup()}}),cafes=new L.GeoJSON.AJAX("data/cafe.min.geojson",{minZoom:8,filter:function(e,t){return null!=e.properties.name},pointToLayer:function(e,t){return L.marker(t,{icon:cafeIcon})},onEachFeature:function(e,t){var a=void 0!==e.properties.name?e.properties.name:"Ei tietoa",o=e.properties.website,r=e.properties.url,i=void 0!==e.properties.url?e.properties.url:e.properties.website,n=void 0!==e.properties.opening_hours?e.properties.opening_hours:"Ei tietoa";if(null==a)var s="Ei tietoa";if(null==o&&null==r)s="Kahvila: "+a+"<br>Aukiolo: "+n;else s='Kahvila: <a target="_blank" href='+i+">"+a+"</a><br>Aukiolo: "+n;t.bindPopup(s,popupOptions).openPopup()}}),stationsCluster=new L.MarkerClusterGroup({showCoverageOnHover:!1,maxClusterRadius:80});stations.on("data:loaded",(function(){stationsCluster.addLayer(stations)}));var cafesCluster=new L.MarkerClusterGroup({showCoverageOnHover:!1,maxClusterRadius:80});cafes.on("data:loaded",(function(){cafesCluster.addLayer(cafes)}));var overlays={"Tien päällyste":roadCover,Nopeusrajoitukset:speedLimit,"Tietyöt":workingSitesGroup,"Liikennehäiriöt":disturbancesGroup,Mutkareitit:geojson,"Huolto-asemat":stationsCluster,Kahvilat:cafesCluster,Selkokartta:selkokartta},baseUrls={HERE:hereMap,Taustakartta:taustakartta,Peruskartta:maastokartta,Mapbox:mapbox},basemaps=[hereMap,maastokartta,taustakartta,mapbox];map.addControl(L.control.basemaps({basemaps:basemaps,tileX:0,tileY:0,tileZ:1})),lc=L.control.locate({strings:{title:"Oma sijainti"},flyTo:!0,showPopup:!1,locateOptions:{maxZoom:15}}).addTo(map);var materialOptions={color:"white"},materialZoomControl=new L.materialControl.Zoom({position:"bottomleft",materialOptions:materialOptions});materialZoomControl.addTo(map);var infoButton=L.control.infoButton({linkTitle:"Motokartat",title:"<h3>Motokartat</h3>",html:'<h6><b>Kartta-aineistot (Map data)</b></h6><ul> <li><a href="https://www.here.com/">HERE</a></li><li><a href="https://www.mapbox.com/">Mapbox</a></li><li><a href="https://www.maanmittauslaitos.fi/avoindata-lisenssi-cc40">Maanmittauslaitos Nimeä CC 4.0 -lisenssi</a>: Taustakartta,peruskartta ja selkokartta</a></li><li><a href="https://www.fintraffic.fi/fi/fintraffic/digitraffic-ja-avoin-data">Fintraffic Nimeä 4.0 Kansainvälinen (CC BY 4.0)</a> : Tietyöt ja liikennehäiriöt</a></li><li><a href="https://wiki.openstreetmap.org/wiki/Overpass_API">OpenStreetMap Overpass API</a> : Kahvilat ja huoltoasemat</a></li><li><a href="http://www.moottoripyora.org/keskustelu/showthread.php/274924-Org!-Mutkareittikartta">Moottoripyörät.org</a> : Org! Mutkareittikartta-keskustelu</a></li><li><a href="https://vayla.fi/">Väylävirasto</a>: Tien päällyste ja nopeusrajoitukset, <a href="https://creativecommons.org/licenses/by/4.0/deed.fi">Creative Commons 4.0</a></li><li><a href="https://www.rainviewer.com/">RainViewer</a>: Säädata -animaatio</a></li></ul><h6><b>Lisenssit (Licenses)</b></h6><ul> <li><a href="https://opensource.org/licenses/mit-license.php">MIT-lisenssi</a></li></ul><h6><b>Kirjastot (Libraries)</b></h6><ul> <li>Map by <a href="http://leafletjs.com/"> Leaflet</a></li><li>Fonts by <a href="https://fontawesome.com/">Font Awesome</a></li><li>Icons by <a target="_blank" href="https://icons8.com">Icons8</a></li><li>Routing by <a href="https://www.liedman.net/leaflet-routing-machine/">Leaflet Routing Machine</a> with <a href="https://www.here.com/">HERE</a></li><li>Material controls by <a href="https://github.com/christippett/leaflet-material"> Leaflet material</a></li><li>Mapbox features by <a href="https://www.mapbox.com/"> Mapbox</a> with <a href="https://github.com/mapbox/mapbox-gl-leaflet">Mapbox GL for Leaflet</a></li><li>Clustering with <a href="https://github.com/Leaflet/Leaflet.markercluster"> Markercluster</a></li><li>Esi features with <a href="https://esri.github.io/esri-leaflet/"> Esri for Leaflet</a></li><li>Locating with <a href="https://github.com/domoritz/leaflet-locatecontrol"> Leaflet locate control</a></li><li>Rain viewer by <a href="https://github.com/mwasil/Leaflet.Rainviewer"> Leaflet Rainviewer</a></li><li>Legends with <a href="https://github.com/kartoza/leaflet-wms-legend"> Leaflet Wms legend</a></li><li>Offline features <a href="https://github.com/allartk/leaflet.offline"> Leaflet offline</a></li><li>Restrore view<a href="https://github.com/makinacorpus/Leaflet.RestoreView"> Leaflet RestoreView</a></li><li>Baselayer changer<a href="https://github.com/consbio/Leaflet.Basemaps"> Leaflet Basemaps</a></li><li>Visual click<a href="https://github.com/MazeMap/Leaflet.VisualClick"> Leaflet VisualClick</a></li><li>Info by<a href="https://github.com/Eclipse1979/Leaflet.infoButton"> Leaflet InfoButton</a></li></ul>'}).addTo(map);L.control.rainviewer({position:"topleft",nextButtonText:">",playStopButtonText:"Päälle/Pois",prevButtonText:"<",positionSliderLabelText:"Tunti:",opacitySliderLabelText:"Läpinäkyvyys:",animationInterval:300,opacity:.5}).addTo(map);const layerswitcher=L.control.layers(null,overlays,{collapsed:!0}).addTo(map),urlTemplate="https://avoin-karttakuva.maanmittauslaitos.fi/avoin/wmts/1.0.0/taustakartta/default/WGS84_Pseudo-Mercator/{z}/{y}/{x}.png?api-key=a8a60737-7849-4969-a55e-7b83db77e13a";function showTileList(){LeafletOffline.getStorageInfo(urlTemplate).then((e=>{const t=document.getElementById("tileinforows");t.innerHTML="";for(let a=0;a<e.length;a+=1){const o=new Date(e[a].createdAt);t.insertAdjacentHTML("beforeend",`<tr><td>${a}</td><td>${e[a].url}</td><td>${e[a].key}</td><td>${o.toDateString()}</td></tr>`)}}))}$("#storageModal").on("show.bs.modal",(()=>{showTileList()}));const baseLayer=L.tileLayer.offline(urlTemplate,{attribution:"Map data {attribution.OpenStreetMap}",minZoom:12,maxZoom:7,saveOnLoad:!1,downsample:!1}),control=L.control.savetiles(baseLayer,{confirm(e,t){window.confirm(`Save ${e._tilesforSave.length}`)&&t()},confirmRemoval(e,t){window.confirm("Remove all the tiles?")&&t()},saveText:'<i class="fa fa-download" aria-hidden="true" title="Save tiles"></i>',rmText:'<i class="fa fa-trash" aria-hidden="true"  title="Remove tiles"></i>'});let storageLayer;const getGeoJsonData=()=>LeafletOffline.getStorageInfo(urlTemplate).then((e=>LeafletOffline.getStoredTilesAsJson(baseLayer,e))),addStorageLayer=()=>{getGeoJsonData().then((e=>{storageLayer=L.geoJSON(e),layerswitcher.addOverlay(storageLayer,"Offline tiilet")}))};let progress;function createClearButton(e,t){var a=L.DomUtil.create("button","",t);return a.setAttribute("type","button"),a.innerHTML=e,a.title="Clear waypoints",a}function createReverseButton(e,t){var a=L.DomUtil.create("button","",t);return a.setAttribute("type","button"),a.innerHTML=e,a.title="Reverse waypoints",a}function createAvoidAll(e,t){var a=L.DomUtil.create("button","",t);return a.setAttribute("type","button"),a.innerHTML=e,a.title="Vältä valtateitä ja päällystämättömiä teitä",a}function createAvoidHighWayButton(e,t){var a=L.DomUtil.create("button","",t);return a.setAttribute("type","button"),a.innerHTML=e,a.title="Vältä valtateitä",a}function createUnpavedRoadsButton(e,t){var a=L.DomUtil.create("button","",t);return a.setAttribute("type","button"),a.innerHTML=e,a.title="Vältä päällystättömiä teitä",a}function createFastestButton(e,t){var a=L.DomUtil.create("button","",t);return a.setAttribute("type","button"),a.innerHTML=e,a.title="Nopein",a}getGeoJsonData().then((e=>{storageLayer=L.geoJSON(e),layerswitcher.addOverlay(storageLayer,"Offline tiilet")})),baseLayer.on("storagesize",(e=>{storageLayer&&(storageLayer.clearLayers(),getGeoJsonData().then((e=>{storageLayer.addData(e)})))})),baseLayer.on("savestart",(e=>{progress=0})),baseLayer.on("savetileend",(()=>{progress+=1}));var geoPlan=L.Routing.Plan.extend({createGeocoders:function(){var e=L.Routing.Plan.prototype.createGeocoders.call(this),t=createClearButton('<i class="fa fa-trash-alt" aria-hidden="true"></i>',e);return reverseButton=createReverseButton('<i class="fa fa-arrows-alt-v" aria-hidden="true"></i>',e),avoidHighWayButton=createAvoidHighWayButton('<i class="fa fa-road" aria-hidden="true"></i>',e),unpavedRoadsButton=createUnpavedRoadsButton('<i class="fa fa-motorcycle" aria-hidden="true"></i>',e),fastestButton=createFastestButton('<i class="fa fa-fast-forward" aria-hidden="true"></i>',e),L.DomEvent.on(t,"click",(function(){this.setWaypoints(),console.log("Waypoints cleared")}),this),L.DomEvent.on(reverseButton,"click",(function(){var e=this.getWaypoints();this.setWaypoints(e.reverse()),console.log("Waypoints reversed")}),this),L.DomEvent.on(unpavedRoadsButton,"click",(function(){routing.getRouter().options.urlParameters.mode="shortest;car;dirtRoad:-1",routing.route(),routing.setWaypoints(routing.getWaypoints()),console.log("Avoid unpaved route")}),this),L.DomEvent.on(avoidHighWayButton,"click",(function(){routing.getRouter().options.urlParameters.mode="shortest;car;motorway:-1",routing.route(),routing.setWaypoints(routing.getWaypoints()),console.log("Avoid motorways route")}),this),L.DomEvent.on(fastestButton,"click",(function(){routing.getRouter().options.urlParameters.mode="fastest;car",routing.route(),routing.setWaypoints(routing.getWaypoints()),console.log("Fastest")}),this),e}}),plan=new geoPlan([],{geocoder:new L.Control.Geocoder.Nominatim,routeWhileDragging:!1,draggableWaypoints:!0}),routing=L.Routing.control({waypoints:[],position:"topright",router:new L.Routing.Here("eXgIn9z6_ajJGIOlSJydOcTe8pa4GzX3Vd_enIhf8q8",{}),plan:plan,show:!1,hide:!0,collapsible:!0,collapseBtn:function(e){var t=L.DomUtil.create("span",e.options.collapseBtnClass);L.DomEvent.on(t,"click",e._toggle,e),e._container.insertBefore(t,e._container.firstChild)},altLineOptions:{styles:[{color:"black",opacity:.15,weight:9},{color:"white",opacity:.8,weight:6},{color:"blue",opacity:.5,weight:2}]}});function createButton(e,t){var a=L.DomUtil.create("button","",t);return a.setAttribute("type","button"),a.innerHTML=e,a.title="Start route location",a}map.addControl(routing);var speedLimitLegend=L.control({position:"bottomright",minZoom:10});speedLimitLegend.onAdd=function(e){var t=L.DomUtil.create("div","info legend");return t.innerHTML+='<img src="https://julkinen.vayla.fi/oskari/action?action_route=GetLayerTile&legend=true&style=nopeusrajoitukset&id=68">',t};var roadCoverLegend=L.control({position:"bottomright",minZoom:10});roadCoverLegend.onAdd=function(e){var t=L.DomUtil.create("div","info legend");return t.innerHTML+='<img src="https://julkinen.vayla.fi/oskari/action?action_route=GetLayerTile&legend=true&style=digiroad%3ADR_Paallystetty_tie_LUOKAT&id=322">',t},map.on("overlayadd",(function(e){"Nopeusrajoitukset"===e.name&&speedLimitLegend.addTo(map)})),map.on("overlayadd",(function(e){"Tien päällyste"===e.name&&roadCoverLegend.addTo(map)})),map.on("overlayremove",(function(e){"Nopeusrajoitukset"===e.name&&map.removeControl(speedLimitLegend)})),map.on("overlayremove",(function(e){"Tien päällyste"===e.name&&map.removeControl(roadCoverLegend)})),map.on("moveend",(function(){map.getZoom()>=13&&map.addControl(control),map.getZoom()<13&&map.removeControl(control)})),map.attributionControl.addAttribution('<a target="_blank" href="https://icons8.com">Icons8</a>'),map.restoreView()||map.setView([65.425,27.51],5);
